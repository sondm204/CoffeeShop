<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Checkout</title>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <link
            th:href="@{'/css/output.css'}"
            href="../static/css/output.css"
            rel="stylesheet"
    />
</head>
<body class="scroll-smooth font-sans">
<div class="flex flex-col bg-coffee-200">
    <!-- NAVBAR SCROLL-->
    <div th:insert="~{common/header-dynamic :: header}"></div>
    <div class="container mx-auto">
        <!-- NAVBAR STATIC-->
        <div th:insert="~{common/header-static :: header}"></div>

        <div id="content" class="grid grid-cols-3 gap-10 py-10">
            <h1 class="col-span-3 text-3xl font-bold">CHECKOUT</h1>
            <div class="col-span-2">
                <div class="mb-5 rounded border border-black p-5">
                    <h2 class="mb-3 text-xl">
                        <i class="fa-solid fa-location-dot"></i> Shipping Address
                    </h2>
                    <div class="mb-3" th:if="${defaultAddress != null}">
                        <input
                                type="hidden"
                                name="addressId"
                                th:value="${defaultAddress.getId()}"
                        />
                        <strong
                                th:text="${defaultAddress.getFullname() + ' (' + defaultAddress.getPhone() + ')'}"
                        ></strong>
                        <span
                                th:text="${defaultAddress.getAddressDetail() + ', ' + defaultAddress.getAddress()}"
                        ></span>
                        <span class="border border-black px-2 py-1">Mặc định</span>
                        <div class="mt-3">
                            <a
                                    class="cursor-pointer rounded bg-coffee-700 px-3 py-2 text-white"
                            >
                                Thay đổi
                            </a>
                        </div>
                    </div>
                    <div th:if="${defaultAddress == null}">
                        <div class="mb-3">You don't have any address yet.</div>
                        <div class="mb-3">
                            <a
                                    class="cursor-pointer rounded bg-coffee-700 px-3 py-2 text-white"
                            >
                                Add address
                            </a>
                        </div>
                        <div
                                class="fixed bottom-0 left-0 right-0 top-0 bg-black opacity-50"
                        ></div>
                        <form
                                action="/CoffeeShop/profile/add-address"
                                class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 rounded bg-white"
                                method="post"
                                th:object="${address}"
                        >
                            <div class="p-3 text-center">
                                <h2 class="mb-5 text-2xl font-bold">Địa chỉ mới</h2>
                                <div class="flex w-full gap-3">
                                    <input
                                            class="mb-3 rounded border border-slate-300 px-3 py-2"
                                            type="text"
                                            name="fullname"
                                            placeholder="Họ và tên"
                                    />
                                    <input
                                            class="mb-3 rounded border border-slate-300 px-3 py-2"
                                            type="text"
                                            name="phone"
                                            placeholder="Số điện thoại"
                                    />
                                </div>
                                <div class="flex w-full flex-col">
                                    <select
                                            class="mb-3 rounded border border-slate-300 px-3 py-2"
                                            name="province"
                                    >
                                        <option value="0" hidden>Tỉnh/Thành Phố</option>
                                    </select>
                                    <select
                                            class="mb-3 rounded border border-slate-300 px-3 py-2"
                                            name="district"
                                    >
                                        <option value="0" hidden>Quận/Huyện</option>
                                    </select>
                                    <select
                                            class="mb-3 rounded border border-slate-300 px-3 py-2"
                                            name="ward"
                                    >
                                        <option value="0" hidden>Phường/Xã</option>
                                    </select>
                                </div>
                                <div>
                                    <input
                                            class="mb-3 w-full rounded border border-slate-300 px-3 py-2"
                                            type="text"
                                            name="address"
                                            placeholder="Địa chỉ cụ thể"
                                    />
                                </div>
                                <div class="ml-1 text-left">
                                    <label class="flex items-center gap-2">
                                        <input
                                                class="scale-150"
                                                type="checkbox"
                                                name="defaultAddress"
                                        />
                                        Đặt làm địa chỉ mặc định
                                    </label>
                                </div>
                                <div class="text-right">
                                    <button
                                            class="rounded bg-slate-300 px-3 py-2 text-gray-700"
                                    >
                                        Trở lại
                                    </button>
                                    <input
                                            type="submit"
                                            class="rounded cursor-pointer bg-coffee-700 px-3 py-2 text-white"
                                            value="Hoàn thành"
                                    >
                                    </input>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-span-2 rounded border border-black">
                    <table class="w-full text-center">
                        <thead class="h-16 bg-black text-white">
                        <tr>
                            <th class="w-2/12">Product</th>
                            <th></th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr
                                id="cartOrder"
                                th:each="cart : ${listCart}"
                                class="border-b border-black"
                        >
                            <td>
                                <div class="flex gap-4 px-5 py-2">
                                    <input
                                            type="hidden"
                                            name="cartId"
                                            th:value="${cart.getId()}"
                                    />
                                    <img
                                            class="rounded-md"
                                            th:src="@{'/img/thumbnail/' + ${cart.getProduct().getThumbnailUrl()}}"
                                            alt=""
                                    />
                                </div>
                            </td>
                            <td>
                                <div
                                        th:text="${cart.getProduct().getProductName()}"
                                ></div>
                                <div th:if="${cart.getProductVariant() != null}">
                                    <div
                                            class="text-sm text-gray-500"
                                            th:each="attribute : ${cart.getProductVariant().getAttribute()}"
                                            th:text="${attribute.getKey() + ': ' + attribute.getValue()}"
                                    ></div>
                                </div>
                            </td>
                            <td
                                    th:text="${cart.getProductVariant() != null ? cart.getProductVariant().getSalePrice() : cart.getProduct().getPrice()}"
                            ></td>
                            <td th:text="${cart.getQuantity()}"></td>
                            <td
                                    id="subtotalPrice"
                                    th:text="${cart.getTotalPrice()}"
                            ></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-span-1">
                <h2 class="pb-3 text-3xl">Cart Totals</h2>
                <hr class="border border-black"/>
                <div class="mt-5">
                    <table
                            class="w-full border-separate border-spacing-y-5 text-left"
                    >
                        <tr>
                            <th class="w-1/2">Subtotal</th>
                            <td><span id="subtotal">0</span><span>đ</span></td>
                        </tr>
                        <tr>
                            <th>Shipping</th>
                            <td>
                                <span id="shipping">20000</span>
                                <span>đ</span>
                            </td>
                        </tr>
                        <tr>
                            <th>Total</th>
                            <td>
                                <span id="total">0</span>
                                <span>đ</span>
                            </td>
                        </tr>
                    </table>
                </div>
                <hr class="mb-3 border border-black"/>
                <div class="mb-3">
                    <h3 class="text-xl">Payment Methods</h3>
                    <div class="mt-2">
                        <div class="mb-3">
                            <input
                                    type="radio"
                                    name="payment"
                                    id="paymentByCash"
                                    value="1"
                                    checked
                            />
                            <label for="paymentByCash">Payment by cash</label>
                        </div>
                        <div class="mb-3">
                            <input
                                    type="radio"
                                    name="payment"
                                    id="paymentByCard"
                                    value="2"
                            />
                            <label for="paymentByCard">Payment by card</label>
                        </div>
                    </div>
                </div>
                <div
                        class="mt-5 cursor-pointer bg-black py-3 text-center text-xl font-bold text-white transition duration-200 ease-in-out hover:bg-white hover:text-black"
                >
                    <div id="place-order">Place Order</div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--  FOOTER-->
<div th:insert="~{common/footer :: footer}"></div>

<!--  Calculate total price-->
<script>
    let totalPrice = 0;
    document.querySelectorAll("#cartOrder").forEach(function (cart) {
        totalPrice += parseInt(
            cart.querySelector("#subtotalPrice").textContent,
        );
    });
    let subtotal = document.getElementById("subtotal");
    let shipping = document.getElementById("shipping");
    let total = document.getElementById("total");
    subtotal.innerText = totalPrice;
    total.innerText = totalPrice + parseInt(shipping.innerText);
</script>

<!--      Place order-->
<script>
    let placeOrder = document.getElementById("place-order");
    placeOrder.addEventListener("click", function () {
        let cartIds = [];
        let cartElement = document.querySelectorAll('input[name="cartId"]');
        cartElement.forEach(function (cart) {
            cartIds.push(cart.value);
        });
        let addressId = document.querySelector('input[name="addressId"]').value;
        let totalAmount = document.getElementById("total").innerText;
        let paymentElements = document.querySelectorAll(
            'input[name="payment"]',
        );
        let paymentMethod = "";
        paymentElements.forEach(function (payment) {
            if (payment.checked) {
                paymentMethod = payment.value;
            }
        });
        fetch("/CoffeeShop/checkout/check", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                cartIds: cartIds,
                addressId: addressId,
                totalAmount: totalAmount,
                paymentMethod: paymentMethod,
            }),
        })
            .then(function (response) {
                return response.text();
            })
            .then(function (data) {
                window.location.replace(data);
            })
            .catch(function (error) {
                console.log(error);
            });
    });
</script>

<!--  Address-->
<script>
    let provinceApi = "https://open.oapi.vn/location/provinces/?size=63";
    let districtApi = "https://open.oapi.vn/location/districts/";
    let wardApi = "https://open.oapi.vn/location/wards/";

    let provinceSelect = document.querySelector('select[name="province"]');
    let districtSelect = document.querySelector('select[name="district"]');
    let wardSelect = document.querySelector('select[name="ward"]');

    async function loadProvinces() {
        let response = await fetch(provinceApi);
        let provinces = (await response.json()).data;
        for (let i = 0; i < provinces.length; i++) {
            let option = document.createElement("option");
            option.value = provinces[i].id;
            option.text = provinces[i].name;
            provinceSelect.add(option);
        }
    }

    loadProvinces();

    async function loadDistricts(provinceCode) {
        let response = await fetch(districtApi + provinceCode);
        let responseFull = await fetch(
            districtApi + provinceCode + "?size=" + (await response.json()).total,
        );
        let districts = await (await responseFull.json()).data;
        districtSelect.innerHTML = "<option value=''>Quận/Huyện</option>";
        for (let i = 0; i < districts.length; i++) {
            let option = document.createElement("option");
            option.value = districts[i].id;
            option.text = districts[i].name;
            districtSelect.add(option);
        }
    }

    async function loadWards(districtCode) {
        let response = await fetch(wardApi + districtCode);
        let responseFull = await fetch(
            wardApi + districtCode + "?size=" + (await response.json()).total,
        );
        let wards = (await responseFull.json()).data;

        wardSelect.innerHTML = "<option value=''>Phường/Xã</option>";
        for (let i = 0; i < wards.length; i++) {
            let option = document.createElement("option");
            option.value = wards[i].id;
            option.text = wards[i].name;
            wardSelect.add(option);
        }
    }

    provinceSelect.addEventListener("change", function () {
        let provinceCode = provinceSelect.value;
        loadDistricts(provinceCode);
    });

    districtSelect.addEventListener("change", function () {
        let districtCode = districtSelect.value;
        loadWards(districtCode);
    });
</script>
</body>
</html>
